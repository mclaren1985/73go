
  <div class="main_right">
   	  <div class="r_hd">
            <h3 class="r_tit">退订</h3>
   	  </div>
        <div  class="BoxHeight mb_10" ></div>
    <div class="order">
      <div class="order_tit" id="datas" data-fid="{$change[0]['choice']['flight'][0]['id']}" data-hid="{$change[0]['choice']['hotel'][0]['id']}" data-tid="{$change[0]['choice']['train'][0]['id']}">
	      <span class="mr_8">订单号：<em>{$change.0.orderNum}</em></span>
	      <span class="mr_8">{$change.0.orderTime}</span>
	      <span class="fl_right">{$change.0.tmcName}</span>
      </div>
          
<!---------------------- 选中的产品（只会有一个） --------------------------------------------------->          


<!---------------------- 选中的机票 ----------------------------------------------------------------> 
<if condition="$change[0]['choice']['flight'] neq null ">
          <table width="100%" border="0" cellspacing="0" cellpadding="0" class="table_fund bg_tab table_pr  line_dashed">
            <tr>
              <td width="5%" rowspan="2"  nowrap="nowrap" ><input type="checkbox" disabled="disabled" checked></input></td>
              <td width="14%" rowspan="2"  nowrap="nowrap" >{$change[0]['choice']['flight'][0]['time_dep']|substr=0,10}
                <!-- 判断有没有保险 -->
                <span class="bx_mr"><a class="a_buy_yq">保险</a></span> <br />
      {$change[0]['choice']['flight'][0][airline_co]} {$change[0]['choice']['flight'][0]['airline_num']}</td>
              <td rowspan="2" ><span class="tex_20">{$change[0]['choice']['flight'][0]['time_dep']|substr=11,5}</span><br />
      {$change[0]['choice']['flight'][0]['city_from']}</td>
              <td width="8%" rowspan="2"  ><p><br />
                经停</p>
                <p>——</p>
                <p>武汉</p>
                <p>&nbsp;</p></td>
              <td rowspan="2" ><span class="tex_20">{$change[0]['choice']['flight'][0]['time_arv']|substr=11,5}</span><br />
      {$change[0]['choice']['flight'][0]['city_to']}</td>
              <td width="8%"><br/>
      {$change[0]['choice']['flight'][0]['class']}</td>
              <td width="5%" nowrap="nowrap"><br/>
                ￥{$change[0]['choice']['flight'][0]['allPrice']}</td>
            </tr>
            <tr>
              <td colspan="2" ><a href="#" class="tex_blue">退改签政策</a></td>
            </tr>
          </table>
</if> 
         
<!---------------------- 选中的酒店 ---------------------------------------------------------------->          
<if condition="$change[0]['choice']['hotel'] neq null ">
            <table width="100%" border="0" cellspacing="0" cellpadding="0" class="table_fund bg_tab table_pr">

                <tr >
                <td width="5%" rowspan="2"  nowrap="nowrap" ><input type="checkbox" disabled="disabled" checked></input></td>
                    <td  width="158px">
                        <p>{$change[0]['choice']['hotel'][0]['date_ckin']}</p>
                        <p>↓</p>
                        <p>{$change[0]['choice']['hotel'][0]['date_ckout']}</p>
                    </td>
                    <td colspan="2" width="281px" class="order_margin ">
                        <p>
                            <span>{$change[0]['choice']['hotel'][0]['hotel_name']}</span>
                        </p>
                        <p>
                            <span style="word-break: break-all;">{$change[0]['choice']['hotel'][0]['hotel_addr']}</span>
                        </p>

                    </td>
                    <td  width="120px">
                        <p style="margin-bottom: 20px">￥{$change[0]['choice']['hotel'][0]['price']}</p>
                        <p style="margin-left: 19px;">{$change[0]['choice']['hotel'][0]['room_type']}</p>
                    </td>
                    <td  width="100px">
                    
                        <if condition="$change[0]['choice']['hotel'][0]['prepay_val'] neq 0 ">
                           <if condition="$change[0]['choice']['hotel'][0]['prepay_status'] eq 0 ">
                             <p style="margin-left: -70px;margin-bottom: 20px">需预付</p>
                           <elseif condition="$change[0]['choice']['hotel'][0]['prepay_status'] eq 1 "/>
                             <p style="margin-left: -70px;margin-bottom: 20px">已预付</p></if>
                        <else/>
                        </if>
    
                        <if condition="$change[0]['choice']['hotel'][0]['crecard_val'] eq 1 ">
                           <if condition="$change[0]['choice']['hotel'][0]['crecard_status'] eq 0 ">
                             <p style="margin-left: -70px;margin-bottom: 20px">需担保</p>
                           <elseif condition="$change[0]['choice']['hotel'][0]['crecard_status'] eq 1 "/>
                             <p style="margin-left: -70px;margin-bottom: 20px">已担保</p></if>
                        <else/>
                        </if> 
                        
                        <p style="margin-left: -70px;">{$change[0]['choice']['hotel'][0]['count']}</p>
                    </td>
                </tr>
            </table>       
</if>      
          
<!---------------------- 选中的火车 ------------------------------------------------------------->          
<if condition="$change[0]['choice']['train'] neq null ">      
  <table width="100%" border="0" cellpadding="0" cellspacing="0" class="table_fund bg_tab">
            <tr>
              <td width="5%" rowspan="2"><input type="checkbox" disabled="disabled" checked></input></td>
              <td width="14%" rowspan="2">{$change[0]['choice']['train'][0]['boarding_time']|substr=0,10}<br />
                G39</td>
              <td width="105" rowspan="2"><span class="tex_20">{$change[0]['choice']['train'][0]['boarding_time']|substr=11,5}</span><br />
      {$change[0]['choice']['train'][0]['station_dep']}</td>
              <td rowspan="2" class="tex_20">——</td>
              <td width="103" rowspan="2"><span class="tex_20">{$change[0]['choice']['train'][0]['boarding_time']|substr=11,5}</span><br />
      {$change[0]['choice']['train'][0]['station_arv']}</td>
              <td><br/>
      {$change[0]['choice']['train'][0]['class_level']}</td>
              <td><br/>
                ￥{$change[0]['choice']['train'][0]['price']}</td>
            </tr>
            <tr>
              <td colspan="2"><a href="#" class="tex_blue">退改签政策</a></td>
            </tr>
      </table>
</if>               
          
          
<!--------------------------------------------------------------------------------------------->          
<!------------------------- 订单中的其他产品 ----------------------------------------------------> 
<!--------------------------------------------------------------------------------------------->  

   
          <div class="bg_hs p4_10">
          <input type="checkbox" id="otherGoods" class=" ml_5" /><span class="ml_14">订单中的其他产品</span></div>
      
<!------------------------- 订单中的其他产品（机票） ----------------------------------------------------> 
<foreach name="change[0]['notChoice']['flight']" item="ncf" key="k">
          <table width="100%" border="0" cellspacing="0" cellpadding="0" class="table_fund bg_tab table_pr  line_dashed">
            <tr>
              <td width="5%" rowspan="2"  nowrap="nowrap" ></td>
              <td width="14%" rowspan="2"  nowrap="nowrap" >{$ncf['time_dep']|substr=0,10}
                <!-- 判断有没有保险 -->
                <span class="bx_mr"><a class="a_buy_yq">保险</a></span> <br />
      {$ncf['airline_co']} {$ncf['airline_num']}</td>
              <td rowspan="2" ><span class="tex_20">{$ncf['time_dep']|substr=11,5}</span><br />
      {$ncf['city_from']}</td>
              <td width="8%" rowspan="2"  ><p><br />
                经停</p>
                <p>——</p>
                <p>武汉</p>
                <p>&nbsp;</p></td>
              <td rowspan="2" ><span class="tex_20">{$ncf['time_arv']|substr=11,5}</span><br />
      {$ncf['city_to']}</td>
              <td width="8%"><br/>
      {$ncf['class']}</td>
              <td width="5%" nowrap="nowrap"><br/>
                ￥{$ncf['allPrice']}</td>
            </tr>
            <tr>
              <td colspan="2" ><a href="#" class="tex_blue">退改签政策</a></td>
            </tr>
          </table>
</foreach >        
    




<!------------------------- 订单中的其他产品（酒店） ----------------------------------------------------> 
<foreach name="change[0]['notChoice']['hotel']" item="nch" key="k">
            <table width="100%" border="0" cellspacing="0" cellpadding="0" class="table_fund bg_tab table_pr">

                <tr >
                    <td  width="158px">
                        <p>{$nch['date_ckin']}</p>
                        <p>↓</p>
                        <p>{$nch['date_ckout']}</p>
                    </td>
                    <td colspan="2" width="281px" class="order_margin ">
                        <p>
                            <span style="margin-left: -73px">{$nch['hotel_name']}</span>
                        </p>
                        <p>
                            <span style="word-break: break-all;">{$nch['hotel_addr']}</span>
                        </p>

                    </td>
                    <td  width="120px">
                        <p style="margin-bottom: 20px">￥{$nch['price']}</p>
                        <p style="margin-left: 19px;">{$nch['room_type']}</p>
                    </td>
                    <td  width="100px">
                    
                        <if condition="$nch['prepay_val'] neq 0 ">
                           <if condition="$nch['prepay_status'] eq 0 ">
                             <p style="margin-left: -70px;margin-bottom: 20px">需预付</p>
                           <elseif condition="$nch['prepay_status'] eq 1 "/>
                             <p style="margin-left: -70px;margin-bottom: 20px">已预付</p></if>
                        <else/>
                        </if>
    
                        <if condition="$nch['crecard_val'] eq 1 ">
                           <if condition="$nch['crecard_status'] eq 0 ">
                             <p style="margin-left: -70px;margin-bottom: 20px">需担保</p>
                           <elseif condition="$nch['crecard_status'] eq 1 "/>
                             <p style="margin-left: -70px;margin-bottom: 20px">已担保</p></if>
                        <else/>
                        </if>
                       
                        <p style="margin-left: -70px;">{$nch['count']}</p>
                    </td>
                </tr>
            </table>       
</foreach >       
       
<!------------------------- 订单中的其他产品（火车） ---------------------------------------------------->
<foreach name="change[0]['notChoice']['train']" item="nct" key="k">          
  <table width="100%" border="0" cellpadding="0" cellspacing="0" class="table_fund bg_tab">
            <tr>
              <td width="5%" rowspan="2">&nbsp;</td>
              <td width="14%" rowspan="2">{$nct['boarding_time']|substr=0,10}<br />
                {$nct['train_num']}</td>
              <td width="105" rowspan="2"><span class="tex_20">{$nct['boarding_time']|substr=11,5}</span><br />
      {$nct['station_dep']}</td>
              <td rowspan="2" class="tex_20">——</td>
              <td width="103" rowspan="2"><span class="tex_20">{$nct['boarding_time']|substr=11,5}</span><br />
      {$nct['station_arv']}</td>
              <td><br/>
      {$nct['class_level']}</td>
              <td><br/>
                ￥{$nct['price']}</td>
            </tr>
            <tr>
              <td colspan="2"><a href="#" class="tex_blue">退改签政策</a></td>
            </tr>
      </table>
</foreach >    
  
<!------------------------- 订单中的其他产品（其他） ---------------------------------------------------->           
<foreach name="change[0]['notChoice']['other']" item="nco" key="k">
      <table width="100%" border="0" cellspacing="0" cellpadding="0" class="table_fund bg_tab">
            <tr>
              <td width="5%">&nbsp;</td>
              <td width="14%">{$nco['time_start']}<br />
                ↓<br />
                {$nco['time_end']}</td>
              <td>{$nco['content']}</td>
              <td width="10%" class="tex_blue">￥{$nco['price']}</td>
            </tr>
          </table>
</foreach >     
     
<!------------------------------------------------------------------------------------------>      
<!------------------------- 退票退单内容 ---------------------------------------------------->  
<!------------------------------------------------------------------------------------------>      
<div class="BoxHeight mb_10 line_dashed"></div>
          <div class="register_mod_form_row mb_10 pa_lr_40">
            <div class="register_mod_form_label">请求退订的人：</div>
            <div class="register_mod_form_cnt">
              <div class="news_mod_form_cnt dt_time01 dt_time_xz"> 
              <!--<a href="javascript:void(0)" class="current2">张三</a> 
              <a href="javascript:void(0)">李四</a>
              <a href="javascript:void(0)" class="yd_bg">小强</a>
              -->
<foreach name="change[0]['name']" item="name" key="k">              
         <a href="javascript:void(0)" class="users_exit" data-user="{$name['id']}">{$name['name']}</a>     
              
</foreach ></div>       
              <div class="clear"></div>
            </div>
          </div>
          <div class="BoxHeight"></div>
          <div class="register_mod_form_row pa_lr_40 mb_10">
            <div class="register_mod_form_label">退订原因：</div>
            <div class="register_mod_form_cnt">
              <!--<div class="pa_15 border_ddd w450 mb_10">&quot;退改签&quot;内容</div>  -->
              <textarea name="exit_content" style="width:450px;height:120px;"></textarea>
            </div>
          </div>
        </div>
    <div class="al_cent mt_22"><button name="confirm" class="btn_sure">提交申请</button></div>
  </div>
    <div class="clear"></div>

    
<script>

$(function(){
	var users = [];
	//<div class="order_tit" id="datas" data-fid="{$change[0]['choice']['flight'][0]['id']}" data-hid="{$change[0]['choice']['hotel'][0]['id']}" data-tid="{$change[0]['choice']['train'][0]['id']}">
	var cacheData = $('#datas');
	var fid = cacheData.attr('data-fid') || 0;
	var hid = cacheData.attr('data-hid') || 0;
	var tid = cacheData.attr('data-tid') || 0;
	
	//退改用户
	$(".users_exit").toggle(
		function(){
			$(this).addClass('current2');
			var uid = $(this).attr('data-user') || 0;
			users.push(uid);
		},
		function(){
			$(this).removeClass('current2');
			var uid = $(this).attr('data-user') || 0;
			users.splice($.inArray(uid,users),1);
		}
	);
	
	$("button[name='confirm']").click(function(){
		if(users.length>0){
			var text = $("textarea[name='exit_content']").val() || '';
			var otherGoods = document.getElementById('otherGoods').checked?1:0;
			$.ajax({
				url:"{:U('Order/refund_submit')}",
				data: {flightId: parseInt(fid), hotelId: parseInt(hid),trainId: parseInt(tid),content: text,nameIdArray: users,allOrder: otherGoods},
				dataType:"JSON",
				type:"POST",
				success:function(msg){
					if(msg==0){
						window.location.href="{:U('Order/order_list_6')}";
						//alert("yes");
					}
					if(msg==1){
						window.location.reload();
					}		
				}
			});
		}else{
			alert("请选择要求退订的用户");
		}
	});
	
});






</script>